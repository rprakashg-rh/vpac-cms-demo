---
name: Build push execution environment images
on:
    push:
        branches:
        - main
        paths:
        - 'execution-environment/**'
    workflow_dispatch:
env:
    IMAGE_NAME: ${{ secrets.EE_IMAGE_NAME }}
    IMAGE_REGISTRY: ${{ secrets.IMAGE_REGISTRY }}
    ANSIBLE_GALAXY_SERVER_RH_HUB_TOKEN: ${{ secrets.AUTOMATION_HUB_TOKEN }}
jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install ansible-builder
      run: |
        pip install ansible-builder==3.*
    
    - name: Login to regisry.redhat.io
      uses: redhat-actions/podman-login@v1
      with:
        registry: registry.redhat.io
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
    
    - name: Generate Containerfile with ansible-builder
      run: |
        ansible-builder create -f execution-environment/ee.yml \
            --output-filename Containerfile \
            --context execution-environment/build-context

    - name: Build EE image
      uses: redhat-actions/buildah-build@v2
      with:
        image: ${{ env.IMAGE_NAME }}
        tags: | 
          latest
          ${{ github.sha }}
        context: execution-environment/build-context
        containerfiles: |
          execution-environment/build-context/Containerfile

    - name: Login to registry
      uses: redhat-actions/podman-login@v1
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Push EE image to registry
      uses: redhat-actions/push-to-registry@v2
      with:
        image: ${{ env.IMAGE_NAME }}
        tags: |
            latest
            ${{ github.sha }}
        registry: ${{ env.IMAGE_REGISTRY }}

    - name: Save the Containerfile as build artifact
      uses: actions/upload-artifact@v6
      with:
        name: containerfile
        path: execution-environment/build-context/Containerfile  